# On push to main with docs content or app changes, deploy to docs production

name: Deploy Docs to Production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "content/**"
      - "scripts/**"
      - "package.json"
      - "next.config.ts"

jobs:
  deploy_docs_prod:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
    env:
      SEARCH_MODE: ${{ secrets.SEARCH_MODE }}
      # Cloudflare configuration
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
      CF_ROUTE_PATTERN: ${{ secrets.CF_ROUTE_PATTERN }}
      CF_WORKER_NAME: ${{ secrets.CF_WORKER_NAME }}
      DOCS_SLACK_FEEDBACK_WEBHOOK: ${{ secrets.DOCS_SLACK_FEEDBACK_WEBHOOK }}
      DOCS_NEXT_PUBLIC_MESH_SDK_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_MESH_SDK_KEY }}
      DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC }}
      DOCS_NEXT_PUBLIC_UNIFY_API_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_API_KEY }}
      DOCS_NEXT_PUBLIC_RB2B_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_RB2B_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.1

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Generate production env file
        run: |
          cat <<EOF > .env.production
          NEXTJS_ENV=production
          SLACK_FEEDBACK_WEBHOOK=${DOCS_SLACK_FEEDBACK_WEBHOOK}
          NEXT_PUBLIC_MESH_SDK_KEY=${DOCS_NEXT_PUBLIC_MESH_SDK_KEY}
          NEXT_PUBLIC_UNIFY_SCRIPT_SRC=${DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC}
          NEXT_PUBLIC_UNIFY_API_KEY=${DOCS_NEXT_PUBLIC_UNIFY_API_KEY}
          NEXT_PUBLIC_RB2B_KEY=${DOCS_NEXT_PUBLIC_RB2B_KEY}
          SEARCH_MODE=${SEARCH_MODE}
          EOF

      - name: Generate Wrangler config for CI
        run: |
          cat <<EOF > wrangler.jsonc
          {
            "$schema": "node_modules/wrangler/config-schema.json",
            "account_id": "${CF_ACCOUNT_ID}",
            "main": ".open-next/worker.js",
            "name": "${CF_WORKER_NAME}",
            "compatibility_date": "2024-12-30",
            "compatibility_flags": [
              "nodejs_compat",
              "global_fetch_strictly_public"
            ],
            "assets": {
              "directory": ".open-next/assets",
              "binding": "ASSETS"
            },
            "services": [{
              "binding": "WORKER_SELF_REFERENCE",
              "service": "${CF_WORKER_NAME}"
            }],
            "routes": [],
            "env": {
              "staging": {
                "workers_dev": true,
                "routes": []
              }
            }
          }
          EOF

      - name: Build OpenNext (no deployment)
        run: |
          set -e
          bun run build:prep
          bunx opennextjs-cloudflare build --config wrangler.jsonc

      - name: Create GitHub Deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: production
          ref: ${{ github.sha }}

      - name: Deploy to Cloudflare Workers (Production)
        id: deploy
        run: |
          set -e
          OUTPUT=$(bunx opennextjs-cloudflare deploy --config wrangler.jsonc)
          echo "$OUTPUT"
          # Extract deployment URL if available
          DEPLOYMENT_URL=$(echo "$OUTPUT" | grep -oE 'https://[^ ]+' | head -1)
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          fi

      - name: Update Deployment Status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: success
          environment-url: ${{ steps.deploy.outputs.deployment_url || 'https://docs.superwall.com/docs/home' }}

      - name: Update Deployment Status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: failure

      - name: Update Deployment Status (cancelled)
        if: cancelled()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: inactive
