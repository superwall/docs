# On open PR with docs content or app changes, deploy to docs staging

name: Deploy Docs to Staging on PR

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "src/**"
      - "content/**"
      - "scripts/**"
      - "package.json"
      - "next.config.ts"

concurrency:
  group: docs-staging-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  deploy_docs_staging:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      deployments: write
      issues: write
      pull-requests: write
    env:
      # Cloudflare configuration
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_STAGING_WORKER_NAME: ${{ secrets.CF_STAGING_WORKER_NAME }}
      DOCS_SLACK_FEEDBACK_WEBHOOK: ${{ secrets.DOCS_SLACK_FEEDBACK_WEBHOOK }}
      DOCS_NEXT_PUBLIC_MESH_SDK_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_MESH_SDK_KEY }}
      DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC }}
      DOCS_NEXT_PUBLIC_UNIFY_API_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_UNIFY_API_KEY }}
      DOCS_NEXT_PUBLIC_RB2B_KEY: ${{ secrets.DOCS_NEXT_PUBLIC_RB2B_KEY }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.18.1

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Create GitHub Deployment
        id: create_deployment
        uses: chrnorm/deployment-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: staging
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Mark deployment in progress
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: in_progress

      - name: Generate production env file
        run: |
          cat <<EOF > .env.production
          NEXTJS_ENV=production
          SLACK_FEEDBACK_WEBHOOK=${DOCS_SLACK_FEEDBACK_WEBHOOK}
          NEXT_PUBLIC_MESH_SDK_KEY=${DOCS_NEXT_PUBLIC_MESH_SDK_KEY}
          NEXT_PUBLIC_UNIFY_SCRIPT_SRC=${DOCS_NEXT_PUBLIC_UNIFY_SCRIPT_SRC}
          NEXT_PUBLIC_UNIFY_API_KEY=${DOCS_NEXT_PUBLIC_UNIFY_API_KEY}
          NEXT_PUBLIC_RB2B_KEY=${DOCS_NEXT_PUBLIC_RB2B_KEY}
          EOF

      - name: Generate Wrangler config for CI
        run: |
          cat <<EOF > wrangler.jsonc
          {
            "$schema": "node_modules/wrangler/config-schema.json",
            "account_id": "${CF_ACCOUNT_ID}",
            "main": ".open-next/worker.js",
            "name": "${CF_STAGING_WORKER_NAME}",
            "compatibility_date": "2024-12-30",
            "compatibility_flags": [
              "nodejs_compat",
              "global_fetch_strictly_public"
            ],
            "assets": {
              "directory": ".open-next/assets",
              "binding": "ASSETS"
            },
            "services": [{
              "binding": "WORKER_SELF_REFERENCE",
              "service": "${CF_STAGING_WORKER_NAME}"
            }],
            "routes": [],
            "env": {
              "staging": {
                "workers_dev": true,
                "routes": []
              }
            }
          }
          EOF

      - name: Build and deploy with preview alias
        id: deploy
        env:
          PR: ${{ github.event.pull_request.number }}
        run: |
          set -e
          yarn build:prep
          yarn opennextjs-cloudflare build --config wrangler.jsonc
          OUTPUT=$(npx wrangler@4.34.0 --config wrangler.jsonc versions upload --name ${CF_STAGING_WORKER_NAME} --preview-alias pr-$PR)
          echo "$OUTPUT"
          # Extract deployment URL
          DEPLOYMENT_URL=$(echo "$OUTPUT" | grep -oE 'https://[^ ]+\.workers\.dev' | head -1)
          # Extract alias URL
          ALIAS_URL=$(echo "$OUTPUT" | grep -oE 'https://pr-[0-9]+-[^ ]+\.workers\.dev' | head -1)
          if [ -z "$ALIAS_URL" ] && [ -n "$DEPLOYMENT_URL" ]; then
            DEPLOYMENT_HOST=$(echo "$DEPLOYMENT_URL" | sed -E 's#https?://([^/]+)/?#\1#')
            WORKER_NAME="${DEPLOYMENT_HOST%%.*}"
            ACCOUNT_DOMAIN="${DEPLOYMENT_HOST#*.}"
            if [ -n "$ACCOUNT_DOMAIN" ] && [ "$ACCOUNT_DOMAIN" != "$DEPLOYMENT_HOST" ]; then
              ALIAS_URL="https://pr-$PR-$WORKER_NAME.$ACCOUNT_DOMAIN"
            fi
          fi
          if [ -z "$ALIAS_URL" ]; then
            ALIAS_URL="https://pr-$PR-${CF_STAGING_WORKER_NAME}.${{ secrets.CF_WORKERS_SUBDOMAIN }}.workers.dev"
          fi
          echo "alias_url=$ALIAS_URL" >> $GITHUB_OUTPUT
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          fi

      - name: Choose environment URL
        id: envurl
        env:
          ALIAS: ${{ steps.deploy.outputs.alias_url }}
          DEPLOYMENT: ${{ steps.deploy.outputs.deployment_url }}
        run: |
          URL="$ALIAS"
          if [ -z "$URL" ]; then
            URL="$DEPLOYMENT"
          fi
          echo "url=${URL}/docs/home" >> $GITHUB_OUTPUT

      - name: Update Deployment Status (success)
        if: success()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: success
          environment-url: ${{ steps.envurl.outputs.url }}

      - name: Update Deployment Status (failure)
        if: failure()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: failure

      - name: Update Deployment Status (cancelled)
        if: cancelled()
        uses: chrnorm/deployment-status@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment-id: ${{ steps.create_deployment.outputs.deployment_id }}
          state: inactive
